<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gerador de Escala de Plant√µes</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    color: #333;
    line-height: 1.6;
    padding: 15px;
    min-height: 100vh;
    overflow-x: hidden;
  }
  
  .container {
    max-width: 100%;
    margin: 0 auto;
    background: white;
    border-radius: 12px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    height: calc(100vh - 30px);
  }
  
  header {
    background: linear-gradient(135deg, #1a5276 0%, #2c3e50 100%);
    color: white;
    padding: 20px;
    text-align: center;
    flex-shrink: 0;
    position: relative;
  }
  
  h1 {
    font-size: clamp(1.5rem, 4vw, 2.2rem);
    margin-bottom: 8px;
    font-weight: 700;
  }
  
  .subtitle {
    font-size: clamp(0.9rem, 2.5vw, 1.1rem);
    opacity: 0.9;
  }
  
  .month-selector {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 15px;
    margin-top: 10px;
    flex-wrap: wrap;
  }
  
  .month-selector select {
    padding: 8px 12px;
    border-radius: 8px;
    border: 1px solid #ddd;
    background: white;
    font-size: 1rem;
  }

  /* Contador Minimalista no Header */
  .header-counter {
    position: absolute;
    top: 15px;
    right: 20px;
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    padding: 8px 12px;
    text-align: center;
    min-width: 80px;
    transition: all 0.3s ease;
  }

  .header-counter:hover {
    background: rgba(255, 255, 255, 0.25);
    transform: translateY(-2px);
  }

  .counter-label {
    font-size: 0.75rem;
    opacity: 0.9;
    margin-bottom: 2px;
    font-weight: 500;
  }

  .counter-value {
    font-size: 1.4rem;
    font-weight: 700;
    line-height: 1;
  }

  .counter-subtitle {
    font-size: 0.65rem;
    opacity: 0.8;
    margin-top: 1px;
  }
  
  .controls {
    padding: 15px;
    background: #f8f9fa;
    border-bottom: 1px solid #eaeaea;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }
  
  .btn {
    padding: 10px 15px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: clamp(0.8rem, 2vw, 1rem);
    flex: 1;
    min-width: 140px;
    justify-content: center;
  }
  
  .btn-primary {
    background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
    color: white;
  }
  
  .btn-success {
    background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
    color: white;
  }
  
  .btn-danger {
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    color: white;
  }
  
  .btn-warning {
    background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
    color: white;
  }
  
  .btn-info {
    background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
    color: white;
  }
  
  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
  }
  
  .legend {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin: 15px;
    padding: 12px;
    background: #f9f9f9;
    border-radius: 8px;
    justify-content: center;
    flex-shrink: 0;
  }
  
  .legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-weight: 500;
    font-size: clamp(0.8rem, 2vw, 1rem);
  }
  
  .legend-color {
    width: 16px;
    height: 16px;
    border-radius: 4px;
    flex-shrink: 0;
  }
  
  .huse-day {
    background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
  }
  
  .huse-night {
    background: linear-gradient(135deg, #1a5276 0%, #2c3e50 100%);
  }
  
  .hrp-day {
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
  }
  
  .hrp-night {
    background: linear-gradient(135deg, #8e44ad 0%, #6c3483 100%);
  }
  
  .conflito {
    background: linear-gradient(135deg, #e74c3c 0%, #e67e22 100%);
  }
  
  .alerta-carro {
    background: linear-gradient(135deg, #ffd93d 0%, #ff9a3d 100%);
  }
  
  .content {
    padding: 15px;
    overflow: auto;
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 20px;
  }
  
  .table-container {
    overflow-x: auto;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    background: white;
    max-height: 100%;
  }
  
  .editable-table {
    width: 100%;
    border-collapse: collapse;
    margin: 0;
    background: white;
    min-width: 800px;
  }
  
  .editable-table thead tr {
    background: linear-gradient(135deg, #1a5276 0%, #2c3e50 100%);
    color: white;
    position: sticky;
    top: 0;
    z-index: 10;
  }
  
  .editable-table th {
    padding: 12px 8px;
    font-weight: 600;
    text-align: center;
    border: 1px solid #1a5276;
    font-size: clamp(0.75rem, 1.5vw, 0.9rem);
    white-space: nowrap;
    position: relative;
  }
  
  .editable-table tbody tr {
    border-bottom: 1px solid #eaeaea;
    transition: background-color 0.2s;
  }
  
  .editable-table tbody tr:nth-child(even) {
    background-color: #f8f9fa;
  }
  
  .editable-table tbody tr:hover {
    background-color: #e8f4fc;
  }
  
  .editable-table td {
    padding: 10px 6px;
    text-align: center;
    border: 1px solid #eaeaea;
    transition: all 0.2s;
    font-size: clamp(0.7rem, 1.5vw, 0.8rem);
    white-space: nowrap;
    position: relative;
  }
  
  .editable-table .hospital-name {
    text-align: left;
    padding-left: 12px;
    font-weight: 600;
    background: #f1f8ff;
    width: 140px;
    font-size: clamp(0.75rem, 1.5vw, 0.9rem);
    position: sticky;
    left: 0;
    z-index: 5;
  }
  
  .plantao-cell {
    border-radius: 6px;
    padding: 6px 4px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    min-width: 32px;
    font-size: clamp(0.7rem, 1.5vw, 0.8rem);
    position: relative;
  }
  
  .plantao-cell:hover {
    transform: scale(1.05);
  }
  
  .plantao {
    background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
    color: white;
  }
  
  .conflito-cell {
    background: linear-gradient(135deg, #e74c3c 0%, #e67e22 100%);
    color: white;
    animation: pulse 2s infinite;
  }
  
  .alerta-carro-cell {
    background: linear-gradient(135deg, #ffd93d 0%, #ff9a3d 100%);
    color: #333;
    font-weight: bold;
    animation: bounce 2s infinite;
  }
  
  @keyframes pulse {
    0% {
      box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7);
    }
    70% {
      box-shadow: 0 0 0 8px rgba(231, 76, 60, 0);
    }
    100% {
      box-shadow: 0 0 0 0 rgba(231, 76, 60, 0);
    }
  }
  
  @keyframes bounce {
    0%, 100% {
      transform: translateY(0);
    }
    50% {
      transform: translateY(-5px);
    }
  }
  
  .empty-cell {
    background: #f8f9fa;
    color: #6c757d;
    cursor: pointer;
    border-radius: 6px;
    padding: 6px 4px;
    transition: all 0.2s;
    font-size: clamp(0.7rem, 1.5vw, 0.8rem);
  }
  
  .empty-cell:hover {
    background: #e9ecef;
    transform: scale(1.05);
  }
  
  .weekend {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    color: #6c757d;
  }
  
  .sunday {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    color: #6c757d;
  }
  
  .folga-cell {
    background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
    color: #2e7d32;
    font-style: italic;
    font-weight: 500;
    border-radius: 6px;
    padding: 6px 4px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: clamp(0.7rem, 1.5vw, 0.8rem);
  }
  
  .folga-cell:hover {
    background: linear-gradient(135deg, #dcedc8 0%, #c5e1a5 100%);
    transform: scale(1.05);
  }
  
  .day-header {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
  }
  
  .day-number {
    font-size: 1.1em;
    font-weight: bold;
  }
  
  .day-name {
    font-size: 0.8em;
    opacity: 0.9;
  }
  
  .carro-indicator {
    position: absolute;
    top: -5px;
    right: -5px;
    font-size: 0.9em;
    animation: drive 3s infinite;
    z-index: 2;
  }
  
  @keyframes drive {
    0%, 100% {
      transform: translateX(0) rotate(0deg);
    }
    25% {
      transform: translateX(3px) rotate(5deg);
    }
    50% {
      transform: translateX(0) rotate(0deg);
    }
    75% {
      transform: translateX(-3px) rotate(-5deg);
    }
  }
  
  .observations-section {
    margin-top: 20px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    overflow: hidden;
  }
  
  .observations-header {
    background: linear-gradient(135deg, #1a5276 0%, #2c3e50 100%);
    color: white;
    padding: 12px 15px;
    font-weight: 600;
    font-size: clamp(1rem, 2.5vw, 1.2rem);
  }
  
  .observations-table {
    width: 100%;
    border-collapse: collapse;
  }
  
  .observations-table th {
    background: #f1f8ff;
    padding: 10px 8px;
    text-align: left;
    font-weight: 600;
    border: 1px solid #eaeaea;
    font-size: clamp(0.75rem, 1.5vw, 0.9rem);
  }
  
  .observations-table td {
    padding: 8px;
    border: 1px solid #eaeaea;
    font-size: clamp(0.7rem, 1.5vw, 0.8rem);
  }
  
  .observations-table input, .observations-table select {
    width: 100%;
    padding: 6px 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: clamp(0.7rem, 1.5vw, 0.8rem);
  }
  
  .observations-table input:focus, .observations-table select:focus {
    outline: none;
    border-color: #3498db;
    box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
  }
  
  .footer {
    text-align: center;
    padding: 15px;
    background: #f8f9fa;
    border-top: 1px solid #eaeaea;
    color: #6c757d;
    font-size: clamp(0.8rem, 2vw, 0.9rem);
    flex-shrink: 0;
  }
  
  .notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 12px 20px;
    background: #2ecc71;
    color: white;
    border-radius: 8px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    transform: translateX(150%);
    transition: transform 0.3s ease;
    z-index: 1001;
    max-width: 300px;
    font-size: clamp(0.8rem, 2vw, 1rem);
  }
  
  .notification.show {
    transform: translateX(0);
  }
  
  .notification.error {
    background: #e74c3c;
  }
  
  .notification.warning {
    background: #f39c12;
  }
  
  .loading {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 1002;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    color: white;
  }
  
  .loading.show {
    display: flex;
  }
  
  .spinner {
    border: 5px solid #f3f3f3;
    border-top: 5px solid #3498db;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
    margin-bottom: 15px;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  /* Melhorias para telas muito pequenas */
  @media (max-width: 576px) {
    body {
      padding: 10px;
    }
    
    .container {
      height: calc(100vh - 20px);
      border-radius: 8px;
    }
    
    header {
      padding: 15px 10px;
    }

    .header-counter {
      position: relative;
      top: auto;
      right: auto;
      margin: 10px auto 0;
      max-width: 120px;
    }
    
    .controls {
      padding: 10px;
      gap: 8px;
    }
    
    .btn {
      min-width: 120px;
      padding: 8px 10px;
    }
    
    .legend {
      margin: 10px;
      padding: 10px;
      gap: 8px;
    }
    
    .content {
      padding: 10px;
    }
    
    .carro-indicator {
      font-size: 0.7em;
      top: -3px;
      right: -3px;
    }
  }
  
  /* Melhorias para telas grandes */
  @media (min-width: 1200px) {
    .container {
      max-width: 1400px;
    }
    
    .editable-table {
      min-width: 1000px;
    }
  }
  
  /* Ajustes para orienta√ß√£o paisagem em dispositivos m√≥veis */
  @media (max-height: 500px) and (orientation: landscape) {
    .container {
      height: auto;
      min-height: 100vh;
    }
    
    header, .controls, .legend {
      flex-shrink: 0;
    }
    
    .content {
      flex: 1;
      min-height: 300px;
    }
  }
</style>
</head>
<body>
  <div class="container">
    <header>
      <h1><i class="fas fa-calendar-alt"></i> Gerador de Escala de Plant√µes</h1>
      <p class="subtitle">Gerencie e exporte suas escalas de plant√£o</p>
      
      <!-- Contador Minimalista no Header -->
      <div class="header-counter">
        <div class="counter-label">TROCAS HRP</div>
        <div class="counter-value" id="hrp-trocas-count">0</div>
        <div class="counter-subtitle">este m√™s</div>
      </div>
      
      <div class="month-selector">
        <select id="month-select">
          <option value="0">Janeiro</option>
          <option value="1">Fevereiro</option>
          <option value="2">Mar√ßo</option>
          <option value="3">Abril</option>
          <option value="4">Maio</option>
          <option value="5">Junho</option>
          <option value="6">Julho</option>
          <option value="7">Agosto</option>
          <option value="8">Setembro</option>
          <option value="9">Outubro</option>
          <option value="10">Novembro</option>
          <option value="11">Dezembro</option>
        </select>
        <select id="year-select">
          <!-- Os anos ser√£o preenchidos dinamicamente -->
        </select>
      </div>
    </header>
    
    <div class="controls">
      <button class="btn btn-primary" id="save-data">
        <i class="fas fa-save"></i> Salvar Dados
      </button>
      <button class="btn btn-info" id="load-data">
        <i class="fas fa-folder-open"></i> Carregar Dados
      </button>
      <button class="btn btn-danger" id="reset-data">
        <i class="fas fa-redo"></i> Redefinir Dados
      </button>
      <button class="btn btn-success" id="export-pdf">
        <i class="fas fa-file-pdf"></i> Exportar para PDF
      </button>
    </div>
    
    <div class="legend">
      <div class="legend-item">
        <div class="legend-color huse-day"></div>
        <span>HUSE Diurno</span>
      </div>
      <div class="legend-item">
        <div class="legend-color huse-night"></div>
        <span>HUSE Noturno</span>
      </div>
      <div class="legend-item">
        <div class="legend-color hrp-day"></div>
        <span>HRP Diurno</span>
      </div>
      <div class="legend-item">
        <div class="legend-color hrp-night"></div>
        <span>HRP Noturno</span>
      </div>
      <div class="legend-item">
        <div class="legend-color conflito"></div>
        <span>Conflito de Hor√°rios</span>
      </div>
      <div class="legend-item">
        <div class="legend-color alerta-carro"></div>
        <span>üöó Deslocamento</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);"></div>
        <span>Folga</span>
      </div>
    </div>
    
    <div class="content">
      <div class="table-container">
        <table class="editable-table" id="escala-table">
          <thead>
            <tr id="table-header">
              <!-- Cabe√ßalho ser√° gerado dinamicamente -->
            </tr>
          </thead>
          <tbody id="table-body">
            <!-- Conte√∫do ser√° gerado dinamicamente -->
          </tbody>
        </table>
      </div>
      
      <div class="observations-section">
        <div class="observations-header">
          <i class="fas fa-clipboard-list"></i> Registro de Trocas e Observa√ß√µes
        </div>
        <div class="table-container">
          <table class="observations-table" id="observations-table">
            <thead>
              <tr>
                <th>Hospitais</th>
                <th>DATA</th>
                <th>DATA TROCA</th>
                <th>Nome</th>
                <th>OBS:</th>
              </tr>
            </thead>
            <tbody id="observations-body">
              <!-- Linhas ser√£o adicionadas dinamicamente -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <div class="footer">
      <p>Escala de Plant√µes - Sistema de Gerenciamento | Desenvolvido para facilitar o controle de escalas</p>
    </div>
  </div>

  <!-- Notifica√ß√£o -->
  <div class="notification" id="notification"></div>

  <!-- Loading -->
  <div class="loading" id="loading">
    <div class="spinner"></div>
    <p>Gerando PDF...</p>
  </div>

  <script>
    // Dados iniciais das escalas
    let escalas = {
      "HUSE Diurno": [],
      "HUSE Noturno": [],
      "HRP Diurno": [],
      "HRP Noturno": []
    };

    // Dados das observa√ß√µes
    let observacoes = [];
    
    // M√™s e ano atuais
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    
    // Dias da semana em portugu√™s
    const diasDaSemana = ['DOM', 'SEG', 'TER', 'QUA', 'QUI', 'SEX', 'S√ÅB'];
    
    // Chave para armazenamento local - INCLUI M√äS E ANO
    function getStorageKey(month, year) {
      return `escala_plantoes_data_${month}_${year}`;
    }
    
    // Fun√ß√£o para contar trocas no HRP
    function contarTrocasHRP() {
      let count = 0;
      
      // Contar observa√ß√µes que s√£o do HRP (Diurno ou Noturno)
      observacoes.forEach(obs => {
        if (obs.hospital && (obs.hospital === 'HRP Diurno' || obs.hospital === 'HRP Noturno')) {
          count++;
        }
      });
      
      return count;
    }
    
    // Fun√ß√£o para atualizar contadores
    function atualizarContadores() {
      const trocasHRP = contarTrocasHRP();
      document.getElementById('hrp-trocas-count').textContent = trocasHRP;
    }
    
    // Fun√ß√£o para mostrar notifica√ß√£o
    function mostrarNotificacao(mensagem, isError = false, isWarning = false) {
      const notification = document.getElementById('notification');
      notification.textContent = mensagem;
      
      if (isError) {
        notification.className = 'notification error';
      } else if (isWarning) {
        notification.className = 'notification warning';
      } else {
        notification.className = 'notification';
      }
      
      notification.classList.add('show');
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, 5000);
    }
    
    // Fun√ß√£o para mostrar/ocultar loading
    function mostrarLoading(mostrar) {
      const loading = document.getElementById('loading');
      if (mostrar) {
        loading.classList.add('show');
      } else {
        loading.classList.remove('show');
      }
    }
    
    // Fun√ß√£o para salvar dados no localStorage
    function salvarDados() {
      try {
        const dadosParaSalvar = {
          escalas: escalas,
          observacoes: observacoes,
          dataSalvamento: new Date().toISOString()
        };
        
        localStorage.setItem(getStorageKey(currentMonth, currentYear), JSON.stringify(dadosParaSalvar));
        atualizarContadores();
        mostrarNotificacao('Dados salvos com sucesso!');
      } catch (error) {
        console.error('Erro ao salvar dados:', error);
        mostrarNotificacao('Erro ao salvar dados!', true);
      }
    }
    
    // Fun√ß√£o para carregar dados do localStorage
    function carregarDados() {
      try {
        const dadosSalvos = localStorage.getItem(getStorageKey(currentMonth, currentYear));
        
        if (dadosSalvos) {
          const dados = JSON.parse(dadosSalvos);
          escalas = dados.escalas || {
            "HUSE Diurno": [],
            "HUSE Noturno": [],
            "HRP Diurno": [],
            "HRP Noturno": []
          };
          observacoes = dados.observacoes || [];
          
          criarTabela();
          criarTabelaObservacoes();
          atualizarContadores();
          mostrarNotificacao('Dados carregados com sucesso!');
        } else {
          // Se n√£o h√° dados salvos para este m√™s/ano, inicializar com arrays vazios
          escalas = {
            "HUSE Diurno": [],
            "HUSE Noturno": [],
            "HRP Diurno": [],
            "HRP Noturno": []
          };
          observacoes = [];
          criarTabela();
          criarTabelaObservacoes();
          atualizarContadores();
          mostrarNotificacao('Nenhum dado salvo encontrado para este m√™s/ano!', true);
        }
      } catch (error) {
        console.error('Erro ao carregar dados:', error);
        mostrarNotificacao('Erro ao carregar dados!', true);
      }
    }
    
    // Fun√ß√£o para detectar conflitos
    function detectarConflitos() {
      const conflitos = {};
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
      
      for (let dia = 1; dia <= daysInMonth; dia++) {
        const plantoesNoDia = [];
        
        Object.keys(escalas).forEach(hospital => {
          if (escalas[hospital].includes(dia)) {
            plantoesNoDia.push(hospital);
          }
        });
        
        if (plantoesNoDia.length > 1) {
          conflitos[dia] = plantoesNoDia;
        }
      }
      
      return conflitos;
    }
    
    // Fun√ß√£o para obter dias com transi√ß√£o noturno ‚Üí diurno e diurno ‚Üí noturno no mesmo dia
    function obterDiasComTransicaoDeslocamento() {
      const diasComTransicao = new Set();
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
      
      const noturnos = ["HUSE Noturno", "HRP Noturno"];
      const diurnos = ["HUSE Diurno", "HRP Diurno"];
      
      // CASO 1: Noturno ‚Üí Diurno (dia anterior ‚Üí dia atual)
      for (let dia = 1; dia <= daysInMonth; dia++) {
        const diaAnterior = dia - 1;
        if (diaAnterior >= 1) {
          const temNoturnoAnterior = noturnos.some(noturno => 
            escalas[noturno].includes(diaAnterior)
          );
          
          const temDiurnoAtual = diurnos.some(diurno => 
            escalas[diurno].includes(dia)
          );
          
          if (temNoturnoAnterior && temDiurnoAtual) {
            diasComTransicao.add(diaAnterior);
            diasComTransicao.add(dia);
          }
        }
      }
      
      // CASO 2: Diurno ‚Üí Noturno no mesmo dia
      for (let dia = 1; dia <= daysInMonth; dia++) {
        const temDiurno = diurnos.some(diurno => 
          escalas[diurno].includes(dia)
        );
        
        const temNoturno = noturnos.some(noturno => 
          escalas[noturno].includes(dia)
        );
        
        if (temDiurno && temNoturno) {
          diasComTransicao.add(dia);
        }
      }
      
      return Array.from(diasComTransicao);
    }
    
    // Fun√ß√£o para criar a tabela
    function criarTabela() {
      const tabelaHead = document.querySelector('#table-header');
      const tabelaBody = document.querySelector('#table-body');
      const conflitos = detectarConflitos();
      const diasComTransicao = obterDiasComTransicaoDeslocamento();
      
      // Limpar conte√∫do existente
      tabelaHead.innerHTML = '<th>Hospitais & Dias</th>';
      tabelaBody.innerHTML = '';
      
      // Obter o n√∫mero de dias no m√™s atual
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
      
      // Adicionar cabe√ßalhos dos dias
      for (let dia = 1; dia <= daysInMonth; dia++) {
        const data = new Date(currentYear, currentMonth, dia);
        const diaSemana = data.getDay();
        
        const th = document.createElement('th');
        
        if (diaSemana === 0 || diaSemana === 6) {
          th.className = diaSemana === 0 ? 'sunday' : 'weekend';
        }
        
        const dayHeader = document.createElement('div');
        dayHeader.className = 'day-header';
        
        const dayNumber = document.createElement('div');
        dayNumber.className = 'day-number';
        dayNumber.textContent = dia;
        
        const dayName = document.createElement('div');
        dayName.className = 'day-name';
        dayName.textContent = diasDaSemana[diaSemana];
        
        if (diasComTransicao.includes(dia)) {
          const carroIndicator = document.createElement('div');
          carroIndicator.className = 'carro-indicator';
          carroIndicator.textContent = 'üöó';
          carroIndicator.title = 'Deslocamento necess√°rio entre hospitais';
          dayHeader.appendChild(carroIndicator);
        }
        
        dayHeader.appendChild(dayNumber);
        dayHeader.appendChild(dayName);
        th.appendChild(dayHeader);
        
        th.setAttribute('data-day', dia);
        tabelaHead.appendChild(th);
      }
      
      // Adicionar linhas para cada hospital
      const hospitaisOrdenados = ["HUSE Diurno", "HUSE Noturno", "HRP Diurno", "HRP Noturno"];
      
      hospitaisOrdenados.forEach(hospital => {
        const tr = document.createElement('tr');
        const tdNome = document.createElement('td');
        tdNome.className = 'hospital-name';
        tdNome.textContent = hospital;
        tr.appendChild(tdNome);
        
        for (let dia = 1; dia <= daysInMonth; dia++) {
          const data = new Date(currentYear, currentMonth, dia);
          const diaSemana = data.getDay();
          
          const td = document.createElement('td');
          
          if (diaSemana === 0 || diaSemana === 6) {
            td.className = diaSemana === 0 ? 'sunday' : 'weekend';
          }
          
          td.setAttribute('data-hospital', hospital);
          td.setAttribute('data-day', dia);
          
          if (escalas[hospital].includes(dia)) {
            const div = document.createElement('div');
            
            if (conflitos[dia] && conflitos[dia].includes(hospital)) {
              div.className = 'plantao-cell conflito-cell';
              div.textContent = 'S';
              div.title = 'Conflito de hor√°rio!';
            } else if (diasComTransicao.includes(dia)) {
              div.className = 'plantao-cell alerta-carro-cell';
              div.textContent = 'S üöó';
              div.title = 'Plant√£o com deslocamento necess√°rio entre hospitais';
            } else {
              div.className = 'plantao-cell plantao';
              div.textContent = 'S';
              div.title = 'Plant√£o confirmado';
            }
            
            div.addEventListener('click', () => {
              togglePlantao(hospital, dia);
            });
            
            td.appendChild(div);
          } else {
            const div = document.createElement('div');
            div.className = 'folga-cell';
            div.textContent = 'Folga';
            div.title = 'Dia de folga - Clique para adicionar plant√£o';
            
            div.addEventListener('click', () => {
              togglePlantao(hospital, dia);
            });
            
            td.appendChild(div);
          }
          
          tr.appendChild(td);
        }
        
        tabelaBody.appendChild(tr);
      });
    }
    
    // Fun√ß√£o para adicionar/remover plant√£o
    function togglePlantao(hospital, dia) {
      const index = escalas[hospital].indexOf(dia);
      
      if (index === -1) {
        escalas[hospital].push(dia);
        escalas[hospital].sort((a, b) => a - b);
      } else {
        escalas[hospital].splice(index, 1);
      }
      
      salvarDados();
      criarTabela();
    }
    
    // Fun√ß√£o para redefinir dados
    function redefinirDados() {
      if (confirm('Tem certeza que deseja redefinir todos os dados para este m√™s/ano?')) {
        escalas = {
          "HUSE Diurno": [],
          "HUSE Noturno": [],
          "HRP Diurno": [],
          "HRP Noturno": []
        };
        
        observacoes = [];
        criarTabela();
        criarTabelaObservacoes();
        salvarDados();
        mostrarNotificacao('Dados redefinidos com sucesso!');
      }
    }
    
    // Fun√ß√£o para criar a tabela de observa√ß√µes
    function criarTabelaObservacoes() {
      const tabelaBody = document.getElementById('observations-body');
      tabelaBody.innerHTML = '';
      
      if (observacoes.length === 0) {
        adicionarLinhaObservacao();
        return;
      }
      
      observacoes.forEach((obs, index) => {
        const tr = document.createElement('tr');
        
        // Hospital
        const tdHospital = document.createElement('td');
        const selectHospital = document.createElement('select');
        selectHospital.innerHTML = `
          <option value="">Selecione</option>
          <option value="HUSE Diurno">HUSE Diurno</option>
          <option value="HUSE Noturno">HUSE Noturno</option>
          <option value="HRP Diurno">HRP Diurno</option>
          <option value="HRP Noturno">HRP Noturno</option>
        `;
        selectHospital.value = obs.hospital || '';
        selectHospital.addEventListener('change', (e) => {
          observacoes[index].hospital = e.target.value;
          salvarDados();
        });
        tdHospital.appendChild(selectHospital);
        tr.appendChild(tdHospital);
        
        // Data
        const tdData = document.createElement('td');
        const inputData = document.createElement('input');
        inputData.type = 'date';
        inputData.value = obs.data || '';
        inputData.addEventListener('change', (e) => {
          observacoes[index].data = e.target.value;
          salvarDados();
        });
        tdData.appendChild(inputData);
        tr.appendChild(tdData);
        
        // Data Troca
        const tdDataTroca = document.createElement('td');
        const inputDataTroca = document.createElement('input');
        inputDataTroca.type = 'date';
        inputDataTroca.value = obs.dataTroca || '';
        inputDataTroca.addEventListener('change', (e) => {
          observacoes[index].dataTroca = e.target.value;
          salvarDados();
        });
        tdDataTroca.appendChild(inputDataTroca);
        tr.appendChild(tdDataTroca);
        
        // Nome
        const tdNome = document.createElement('td');
        const inputNome = document.createElement('input');
        inputNome.type = 'text';
        inputNome.value = obs.nome || '';
        inputNome.placeholder = 'Digite o nome';
        inputNome.addEventListener('change', (e) => {
          observacoes[index].nome = e.target.value;
          salvarDados();
        });
        tdNome.appendChild(inputNome);
        tr.appendChild(tdNome);
        
        // Observa√ß√£o
        const tdObs = document.createElement('td');
        const inputObs = document.createElement('input');
        inputObs.type = 'text';
        inputObs.value = obs.observacao || '';
        inputObs.placeholder = 'Digite uma observa√ß√£o';
        inputObs.addEventListener('change', (e) => {
          observacoes[index].observacao = e.target.value;
          salvarDados();
        });
        tdObs.appendChild(inputObs);
        tr.appendChild(tdObs);
        
        tabelaBody.appendChild(tr);
      });
      
      adicionarLinhaObservacao();
    }
    
    // Fun√ß√£o para adicionar uma nova linha de observa√ß√£o
    function adicionarLinhaObservacao() {
      const tabelaBody = document.getElementById('observations-body');
      const tr = document.createElement('tr');
      
      // Hospital
      const tdHospital = document.createElement('td');
      const selectHospital = document.createElement('select');
      selectHospital.innerHTML = `
        <option value="">Selecione</option>
        <option value="HUSE Diurno">HUSE Diurno</option>
        <option value="HUSE Noturno">HUSE Noturno</option>
        <option value="HRP Diurno">HRP Diurno</option>
        <option value="HRP Noturno">HRP Noturno</option>
      `;
      selectHospital.addEventListener('change', (e) => {
        if (e.target.value) {
          observacoes.push({
            hospital: e.target.value,
            data: '',
            dataTroca: '',
            nome: '',
            observacao: ''
          });
          salvarDados();
          criarTabelaObservacoes();
        }
      });
      tdHospital.appendChild(selectHospital);
      tr.appendChild(tdHospital);
      
      // Data
      const tdData = document.createElement('td');
      const inputData = document.createElement('input');
      inputData.type = 'date';
      inputData.addEventListener('change', (e) => {
        if (e.target.value) {
          observacoes.push({
            hospital: '',
            data: e.target.value,
            dataTroca: '',
            nome: '',
            observacao: ''
          });
          salvarDados();
          criarTabelaObservacoes();
        }
      });
      tdData.appendChild(inputData);
      tr.appendChild(tdData);
      
      // Data Troca
      const tdDataTroca = document.createElement('td');
      const inputDataTroca = document.createElement('input');
      inputDataTroca.type = 'date';
      inputDataTroca.addEventListener('change', (e) => {
        if (e.target.value) {
          observacoes.push({
            hospital: '',
            data: '',
            dataTroca: e.target.value,
            nome: '',
            observacao: ''
          });
          salvarDados();
          criarTabelaObservacoes();
        }
      });
      tdDataTroca.appendChild(inputDataTroca);
      tr.appendChild(tdDataTroca);
      
      // Nome
      const tdNome = document.createElement('td');
      const inputNome = document.createElement('input');
      inputNome.type = 'text';
      inputNome.placeholder = 'Digite o nome';
      inputNome.addEventListener('change', (e) => {
        if (e.target.value) {
          observacoes.push({
            hospital: '',
            data: '',
            dataTroca: '',
            nome: e.target.value,
            observacao: ''
          });
          salvarDados();
          criarTabelaObservacoes();
        }
      });
      tdNome.appendChild(inputNome);
      tr.appendChild(tdNome);
      
      // Observa√ß√£o
      const tdObs = document.createElement('td');
      const inputObs = document.createElement('input');
      inputObs.type = 'text';
      inputObs.placeholder = 'Digite uma observa√ß√£o';
      inputObs.addEventListener('change', (e) => {
        if (e.target.value) {
          observacoes.push({
            hospital: '',
            data: '',
            dataTroca: '',
            nome: '',
            observacao: e.target.value
          });
          salvarDados();
          criarTabelaObservacoes();
        }
      });
      tdObs.appendChild(inputObs);
      tr.appendChild(tdObs);
      
      tabelaBody.appendChild(tr);
    }
    
    // Fun√ß√£o para exportar para PDF
    function exportarParaPDF() {
      mostrarLoading(true);
      
      setTimeout(() => {
        try {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF('l', 'mm', 'a4');
          const tabela = document.getElementById('escala-table');
          const tabelaObservacoes = document.getElementById('observations-table');
          const trocasHRP = contarTrocasHRP();
          
          const monthNames = [
            "Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho",
            "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"
          ];
          const monthName = monthNames[currentMonth];
          
          // P√ÅGINA 1: ESCALA DE PLANT√ïES
          doc.setFontSize(20);
          doc.setTextColor(26, 82, 118);
          doc.text(`Escala de Plant√µes - ${monthName} ${currentYear}`, 20, 20);
          
          // Adicionar data de gera√ß√£o
          doc.setFontSize(10);
          doc.setTextColor(100, 100, 100);
          doc.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')} ${new Date().toLocaleTimeString('pt-BR')}`, 20, 30);
          
          // Converter a tabela para imagem
          html2canvas(tabela, {
            scale: 2,
            useCORS: true,
            logging: false
          }).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const imgWidth = 270;
            const imgHeight = (canvas.height * imgWidth) / canvas.width;
            
            // Adicionar a imagem da tabela ao PDF
            doc.addImage(imgData, 'PNG', 15, 40, imgWidth, imgHeight);
            
            // Adicionar informa√ß√µes b√°sicas (sem legenda detalhada)
            const infoY = 40 + imgHeight + 15;
            doc.setFontSize(12);
            doc.setTextColor(26, 82, 118);
            doc.text('INFORMA√á√ïES:', 20, infoY);
            
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            
            const informacoes = [
              '‚Ä¢ Plant√µes noturnos: 19h √†s 7h do dia seguinte',
              '‚Ä¢ Plant√µes diurnos: 7h √†s 19h',
              '‚Ä¢ S√≠mbolo "S" indica plant√£o confirmado',
              '‚Ä¢ "Folga" indica dia sem plant√£o',
              '‚Ä¢ üöó indica deslocamento necess√°rio entre hospitais',
              '‚Ä¢ C√©lulas em vermelho indicam conflito de hor√°rios'
            ];
            
            informacoes.forEach((info, index) => {
              doc.text(info, 20, infoY + 10 + (index * 5));
            });
            
            // Adicionar rodap√© na primeira p√°gina
            const pageHeight = doc.internal.pageSize.height;
            doc.setFontSize(9);
            doc.setTextColor(150, 150, 150);
            doc.text('P√°gina 1 de 2 - Escala de Plant√µes', 20, pageHeight - 10);
            
            // P√ÅGINA 2: TROCAS E OBSERVA√á√ïES
            doc.addPage();
            
            // T√≠tulo da segunda p√°gina
            doc.setFontSize(20);
            doc.setTextColor(26, 82, 118);
            doc.text(`Registro de Trocas e Observa√ß√µes - ${monthName} ${currentYear}`, 20, 20);
            
            // Adicionar contador de trocas HRP
            doc.setFontSize(16);
            doc.setTextColor(231, 76, 60);
            doc.text(`Trocas no HRP este m√™s: ${trocasHRP}`, 20, 40);
            
            // Adicionar tabela de observa√ß√µes se houver dados
            if (observacoes.length > 0) {
              // Criar uma c√≥pia da tabela de observa√ß√µes com fonte maior para exporta√ß√£o
              const tabelaObservacoesClone = tabelaObservacoes.cloneNode(true);
              
              // Aumentar a fonte das c√©lulas da tabela de observa√ß√µes
              const todasAsCelulas = tabelaObservacoesClone.querySelectorAll('td, th');
              todasAsCelulas.forEach(celula => {
                celula.style.fontSize = '14px';
                celula.style.padding = '12px 8px';
              });
              
              // Aumentar a fonte dos inputs e selects
              const todosInputs = tabelaObservacoesClone.querySelectorAll('input, select');
              todosInputs.forEach(input => {
                input.style.fontSize = '14px';
                input.style.padding = '8px';
                input.style.height = 'auto';
              });
              
              // Adicionar a tabela clonada temporariamente ao DOM para captura
              tabelaObservacoesClone.style.position = 'absolute';
              tabelaObservacoesClone.style.left = '-9999px';
              tabelaObservacoesClone.style.top = '0';
              tabelaObservacoesClone.style.width = tabelaObservacoes.offsetWidth + 'px';
              document.body.appendChild(tabelaObservacoesClone);
              
              // Converter a tabela de observa√ß√µes com fonte maior para imagem
              html2canvas(tabelaObservacoesClone, {
                scale: 2,
                useCORS: true,
                logging: false,
                width: tabelaObservacoes.offsetWidth
              }).then(canvasObs => {
                // Remover a tabela clonada do DOM
                document.body.removeChild(tabelaObservacoesClone);
                
                const imgDataObs = canvasObs.toDataURL('image/png');
                const imgWidthObs = 270;
                const imgHeightObs = (canvasObs.height * imgWidthObs) / canvasObs.width;
                
                // Adicionar a imagem da tabela de observa√ß√µes ao PDF
                doc.addImage(imgDataObs, 'PNG', 15, 55, imgWidthObs, imgHeightObs);
                
                // Adicionar informa√ß√µes sobre as trocas com fonte maior
                const infoObsY = 55 + imgHeightObs + 15;
                doc.setFontSize(12);
                doc.setTextColor(100, 100, 100);
                doc.text('‚Ä¢ As trocas devem ser comunicadas com anteced√™ncia √† chefia', 20, infoObsY);
                doc.text('‚Ä¢ Observa√ß√µes devem ser registradas para controle', 20, infoObsY + 8);
                
                // Adicionar rodap√© na segunda p√°gina
                const pageHeight2 = doc.internal.pageSize.height;
                doc.setFontSize(9);
                doc.setTextColor(150, 150, 150);
                doc.text('P√°gina 2 de 2 - Registro de Trocas e Observa√ß√µes', 20, pageHeight2 - 15);
                doc.text('Sistema de Gerenciamento de Escalas - Desenvolvido para facilitar o controle de plant√µes', 
                        20, pageHeight2 - 8);
                
                // Salvar o PDF
                doc.save(`Escala_Plant√µes_${monthName}_${currentYear}.pdf`);
                
                mostrarLoading(false);
                mostrarNotificacao('PDF exportado com sucesso!');
              }).catch(error => {
                // Remover a tabela clonada em caso de erro
                if (document.body.contains(tabelaObservacoesClone)) {
                  document.body.removeChild(tabelaObservacoesClone);
                }
                console.error('Erro ao gerar tabela de observa√ß√µes:', error);
                mostrarLoading(false);
                mostrarNotificacao('Erro ao gerar PDF!', true);
              });
            } else {
              // Se n√£o h√° observa√ß√µes, adicionar mensagem com fonte maior
              doc.setFontSize(14);
              doc.setTextColor(100, 100, 100);
              doc.text('Nenhuma troca ou observa√ß√£o registrada para este m√™s.', 20, 60);
              
              // Adicionar informa√ß√µes sobre trocas
              doc.setFontSize(12);
              doc.text('‚Ä¢ As trocas devem ser comunicadas com anteced√™ncia √† chefia', 20, 80);
              doc.text('‚Ä¢ Observa√ß√µes devem ser registradas para controle', 20, 95);
              
              // Adicionar rodap√© na segunda p√°gina
              const pageHeight2 = doc.internal.pageSize.height;
              doc.setFontSize(9);
              doc.setTextColor(150, 150, 150);
              doc.text('P√°gina 2 de 2 - Registro de Trocas e Observa√ß√µes', 20, pageHeight2 - 15);
              doc.text('Sistema de Gerenciamento de Escalas - Desenvolvido para facilitar o controle de plant√µes', 
                      20, pageHeight2 - 8);
              
              // Salvar o PDF
              doc.save(`Escala_Plant√µes_${monthName}_${currentYear}.pdf`);
              
              mostrarLoading(false);
              mostrarNotificacao('PDF exportado com sucesso!');
            }
          }).catch(error => {
            console.error('Erro ao gerar PDF:', error);
            mostrarLoading(false);
            mostrarNotificacao('Erro ao gerar PDF!', true);
          });
          
        } catch (error) {
          console.error('Erro ao exportar para PDF:', error);
          mostrarLoading(false);
          mostrarNotificacao('Erro ao exportar para PDF!', true);
        }
      }, 100);
    }
    
    // Fun√ß√£o para preencher o seletor de anos
    function preencherAnos() {
      const yearSelect = document.getElementById('year-select');
      const currentYear = new Date().getFullYear();
      
      for (let year = 2020; year <= 2030; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
      }
      
      yearSelect.value = currentYear;
    }
    
    // Inicializa√ß√£o
    document.addEventListener('DOMContentLoaded', function() {
      preencherAnos();
      document.getElementById('month-select').value = currentMonth;
      carregarDados();
      criarTabela();
      criarTabelaObservacoes();
      
      document.getElementById('save-data').addEventListener('click', salvarDados);
      document.getElementById('load-data').addEventListener('click', carregarDados);
      document.getElementById('reset-data').addEventListener('click', redefinirDados);
      document.getElementById('export-pdf').addEventListener('click', exportarParaPDF);
      
      document.getElementById('month-select').addEventListener('change', (e) => {
        currentMonth = parseInt(e.target.value);
        carregarDados();
      });
      
      document.getElementById('year-select').addEventListener('change', (e) => {
        currentYear = parseInt(e.target.value);
        carregarDados();
      });
      
      window.addEventListener('beforeunload', salvarDados);
    });
  </script>
</body>
</html>